<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="茨城県知事選2017の得票データを可視化した地図です。">
<meta property="og:description" content="茨城県知事選2017の得票データを可視化した地図です。">
<meta property="og:type" content="website">
<meta property="og:title" content="茨城県知事選2017 | 水戸地図<">
<meta property="og:url" content="https://cieloazul310.github.io/figure/ibaraki_election2017/">
<meta property="og:site_name" content="水戸地図">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="茨城県知事選2017 | 水戸地図<">
<meta name="twitter:description" content="茨城県知事選2017の得票データを可視化した地図です。">
<meta property="og:image" content="https://cieloazul310.github.io/figure/ibaraki_election2017/thumb.png">
<style>
  @font-face{
    font-family: "Original Yu Gothic";
    src: local("Yu Gothic");
    font-weight: 300;
  }

  @font-face{
    font-family: "Original Yu Gothic";
    src: local("Yu Gothic");
    font-weight: 500;
  }

  @font-face{
    font-family: "Original Yu Gothic";
    src: local("Yu Gothic");
    font-weight: bold;
  }
  @font-face {
    font-family: "Helvetica Neue";
    src: local("Helvetica Neue Regular");
    font-weight: 100;
  }
  @font-face {
    font-family: "Helvetica Neue";
    src: local("Helvetica Neue Regular");
    font-weight: 200;
  }

  /* IE10以上 */
  @media all and (-ms-high-contrast: none)  {
    html {
      font-family: Verdana, Meiryo, sans-serif;
    }
  }
  @media all and (-ms-high-contrast: active) {
    html {
      font-family: Verdana, Meiryo, sans-serif;
    }
  }
  html {
    font-size: 62.5%;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Original Yu Gothic", "Yu Gothic", YuGothic, Verdana, Meiryo, "M+ 1p", sans-serif;
  }

  body {
    margin: 0;
    padding: 0;
  }

  h1 {
    text-align: center;
  }

  .chart-container {
    margin: 0 auto;
    padding: 0;
    width: 100%;
    max-width: 600px;
  }

  .chart-container-inner {
    position: relative;
  }

  svg#chart {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
  }

  path.selected {
    fill: none;/*
    stroke: #fff500;*/
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  path {
    cursor: pointer;
  }

  #info {
    width: 200px;
    max-width: 35%;
    position: absolute;
    top: .5em;
    left: .5em;
    background: rgba(255, 255, 255, 0.8);
    font-size: 1.4rem;
    padding: .5em;
    -webkit-border-radius: 2px;
    -moz-border-radius: 2px;
    border-radius: 2px;
    -webkit-box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.2);
    -moz-box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.2);
    box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.2);
  }

  #info h4 {
    text-align: center;
    margin: auto;
  }

  #info p {
    margin: auto;
    text-align: center;
  }

  #info small {
    color: gray;
    cursor: pointer;
  }

  #info small.active {
    color: #007cd6;
    font-weight: bold;
  }

  div#info table {
    width: 100%;
    font-size: 1.2rem;
    margin-bottom: 0.5em;
  }

  div#info tr {
    height: 100%;
  }

  div#info td {
    height: 100%;
  }

  .td-name {
    width: 3.4em;
    text-align: right;
  }

  div.outer {
    width: 100%;
    height: 1em;
    min-width: 5em;
  }
  div.inner {
    width: 0%;
    height: 100%;
  }

  div.inner span {
    position: absolute;
    right: 0.4em;
    font-size: 1rem;
    text-shadow: 0 0 4px rgba(255,255,255,1);
  }

  .subinfo ul {
    margin: auto;
    padding: inherit;
    font-size: 1.1rem;
  }

  .subinfo li {
    display: inline-block;
  }

</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>
<title>茨城県知事選2017 | 水戸地図</title>
<script>
  (function(i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function() {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

  ga('create', 'UA-74683419-3', 'auto');
  ga('send', 'pageview');
</script>
<div class="chart-container">
  <h1>茨城県知事選 2017</h1>
  <div class="chart-container-inner">
    <svg id="chart"></svg>
    <div id="info">
      <h4>茨城県</h4>
      <p><small class="active" data-guide="得票率">得票率</small> &#124; <small data-guide="得票数">得票数</small></p>
      <div id="subchart">
      </div>
      <div class="subinfo">
        <ul>
          <li>有権者: <span id="voter">214,231人</span></li>
          <li>投票率: <span id="voterate">42.5%</span></li>
          <li>大井川-橋本: <span id="difference">+12.2</span></li>
        </ul>
      </div>
    </div>
  </div>
</div>
<script>

  const q = d3.queue()
              .defer(d3.json, "./ibaraki_h28_merge.topojson")
              .defer(d3.csv, "./data.csv");

  q.await((err, json, csv) => {
    if (err) throw err;

    // merge csv to topojson
    // and create new object for candidates

    const candidates = {
      "大井川": {
        name: "大井川かずひこ",
        firstname: "大井川",
        color: "#50bcff",
        values: {}
      },
      "橋本": {
        name: "橋本まさる",
        firstname: "橋本",
        color: "#ff6a85",
        values: {}
      },
      "鶴田": {
        name: "鶴田まこみ",
        firstname: "鶴田",
        color: "#d0d73d",
        values: {}
      }
    };

    const cities = topojson.feature(json, json.objects.cities).features;

    for (const feature of cities) {
      const idx = csv.map(d => d["行政コード"]).indexOf(feature.properties.N03_007);
      feature.properties = Object.assign(feature.properties, csv[idx]);

      candidates["大井川"].values[feature.properties["市町村名"]] = {"得票数": +feature.properties["大井川かずひこ"], "得票率": +feature.properties["得票率大井川"]};
      candidates["橋本"].values[feature.properties["市町村名"]] = {"得票数": +feature.properties["橋本まさる"], "得票率": +feature.properties["得票率橋本"]};
      candidates["鶴田"].values[feature.properties["市町村名"]] = {"得票数": +feature.properties["鶴田まこみ"], "得票率": +feature.properties["得票率鶴田"]};
    }

    for (const person in candidates) {
      candidates[person].sum = {
        "得票数": +csv[0][candidates[person].name],
        "得票率": +csv[0]["得票率" + person]
      };
      candidates[person].values["茨城県"] = candidates[person].sum;
    }

    // visualization types

    const types = {
      difference: {
        title: "大井川氏と橋本氏のポイント差",
        description: "市町村における大井川氏の得票率から橋本氏の得票率を引いたもの",
        unit: "%",
        cast: function(d) {
          return +d["得票率大井川"] - +d["得票率橋本"];
        }
      },
      attendance: {
        title: "投票率",
        description: "市町村における投票率（投票者数/有権者数）",
        unit: "%",
        cast: function(d) {
          return d["投票率"];
        }
      }
    };

    const config = {
      current: "difference",
      currentInfo: "得票率",
      selectedCity: "茨城県",
      selected: false
    };

    const format = d3.format("+.2%");

    const rateDiff = csv.map(d => Math.abs(types[config.current].cast(d)));
    const rateColor = d3.scaleLinear()
                        .domain([-d3.max(rateDiff), 0, d3.max(rateDiff)])
                        .range(["#b9384f", "white", "#3d97d0"]).nice();

    const rateForWidth = d3.scaleLinear()
                            .domain([0, 0.6])
                            .range([0, 100]);

    const svg = d3.select("#chart");

    const h1margin = parseFloat(d3.select("h1").style("margin").split(" ")[0].slice(0, -2));

    const size = {
      width: parseInt(svg.style("width")),
      height: /*parseInt(d3.select(".chart-container").style("height").slice(0, -2))*/window.innerHeight - parseInt(d3.select("h1").style("height").slice(0,-2)) - (h1margin * 2)
    };
    const padding = {
      top: 4,
      right: 4,
      bottom: 40,
      left: 4
    };

    const info = d3.select("#info");

    svg.attr("width", size.width)
        .attr("height", size.height);

    const merged = topojson.merge(json, json.objects.cities.geometries);

    const projection = d3.geoMercator()
                        .fitExtent([[padding.left, padding.top],[size.width - padding.right, size.height - padding.bottom]], merged);

    const path = d3.geoPath()
                .projection(projection);

    // render maps

    svg.append("g")
        .append("rect")
        .datum(csv[0])
        .attr("width", size.width)
        .attr("height", size.height - padding.bottom)
        .attr("x", 0)
        .attr("y", 0)
        .attr("fill", "white")
        .on("mouseover", (d) => {
          if (config.selected) return;
          config.selectedCity = "茨城県";
          if (config.currentInfo === "得票数") rateForWidth.domain([0, 500000]);
          updateInfo();
          info.select("#difference")
              .text(d3.format("+.1f")(types.difference.cast(d)*100));
          info.select("#voter")
              .text(d3.format(",")(d["有権者数"]) + "人");
          info.select("#voterate")
              .text(d3.format(".1%")(d["投票率"]));
        })
        .on("click", (d) => {
          config.selected = false;
          overlay1.selectAll(".selected")
                  .remove();
          config.selectedCity = "茨城県";
          if (config.currentInfo === "得票数") rateForWidth.domain([0, 500000]);
          updateInfo();
          info.select("#difference")
              .text(d3.format("+.1f")(types.difference.cast(d)*100));
          info.select("#voter")
              .text(d3.format(",")(d["有権者数"]) + "人");
          info.select("#voterate")
              .text(d3.format(".1%")(d["投票率"]));
        });

    const baselayer = svg.append("g");
    const overlay1 = svg.append("g");

    baselayer.selectAll(".cities")
              .data(cities.sort((a, b) => types[config.current].cast(b.properties) - types[config.current].cast(a.properties)))
              .enter()
              .append("path")
              .attr("class", (d) => {
                const cla = ["cities"];
                const rate = types[config.current].cast(d.properties);
                if (rate < -0.2) cla.push("rate-20");
                else if (rate < -0.1) cla.push("rate-10");
                else if (rate < -0.05) cla.push("rate-5");
                else if (rate <= 0.05) cla.push("rate0");
                else if (rate <= 0.1) cla.push("rate5");
                else if (rate <= 0.2) cla.push("rate10");
                else if (rate > 0.2) cla.push("rate20");
                return cla.join(" ");
              })
              .attr("d", path)
              .attr("fill", "white")
              .on("mouseover", (d, i, nodes) => {

                if (config.selected) return;
                config.selectedCity = d.properties["市町村名"];
                if (config.currentInfo === "得票数") rateForWidth.domain([0, 60000]);
                updateInfo();
                info.select("#difference")
                    .text(d3.format("+.1f")(types.difference.cast(d.properties)*100));
                info.select("#voter")
                    .text(d3.format(",")(d.properties["有権者数"]) + "人");
                info.select("#voterate")
                    .text(d3.format(".1%")(d.properties["投票率"]));
                overlay1.append("path")
                        .datum(d)
                        .attr("class", "selected")
                        .attr("d", path)
                        .style("stroke", types[config.current].cast(d.properties) >= 0 ? d3.rgb(rateColor.range()[2]).darker() : d3.rgb(rateColor.range()[0]).darker());
              })
              .on("mouseout", (d, i, nodes) => {
                if (config.selected) return;
                overlay1.selectAll(".selected")
                        .remove();
              })
              .on("click", (d, i, nodes) => {
                if (!config.selected) {
                  config.selected = true;
                  return;
                } else if (config.selectedCity === d.properties["市町村名"]){
                  config.selected = false;
                  return;
                } else {
                  overlay1.selectAll(".selected")
                          .remove();
                  config.selectedCity = d.properties["市町村名"];
                  if (config.currentInfo === "得票数") rateForWidth.domain([0, 60000]);
                  updateInfo();
                  info.select("#difference")
                      .text(d3.format("+.1f")(types.difference.cast(d.properties)*100));
                  info.select("#voter")
                      .text(d3.format(",")(d.properties["有権者数"]) + "人");
                  info.select("#voterate")
                      .text(d3.format(".1%")(d.properties["投票率"]));
                  overlay1.append("path")
                          .datum(d)
                          .attr("class", "selected")
                          .attr("d", path)
                          .style("stroke", types[config.current].cast(d.properties) >= 0 ? d3.rgb(rateColor.range()[2]).darker() : d3.rgb(rateColor.range()[0]).darker());
                }
              })
              .transition()
              .delay((d, i) => i * 50 + 500)
              .duration(1000)
              .attr("fill", (d) => rateColor(types[config.current].cast(d.properties)));

    baselayer.append("path")
        .datum(topojson.mesh(json, json.objects.cities, (a, b) => a !== b))
        .attr("class", "mesh")
        .attr("d", path)
        .attr("fill", "none")
        .attr("stroke", "#777")
        .attr("stroke-width", .5);

    baselayer.append("path")
        .datum(topojson.mesh(json, json.objects.cities, (a, b) => a === b))
        .attr("d", path)
        .attr("fill", "none")
        .attr("stroke", "black");

    // about info

    const table = d3.select("#subchart").append("table");
    const rows = table.selectAll("tr")
                      .data(d3.values(candidates))
                      .enter()
                      .append("tr");

    rows.append("td")
        .attr("class", "td-name")
        .text(d => d.firstname);

    rows.append("td")
        .append("div")
        .attr("class", "outer")
          .append("div")
          .attr("class", "inner")
          .style("width", 0)
          .style("background-color", d => d.color);

    rows.selectAll("div.inner")
          .transition()
          .delay(500).duration(250)
          .style("width", d => rateForWidth(d.sum[config.currentInfo]) + "%");

    rows.selectAll("div.inner")
          .append("span")
          .text(d => d3.format(".1f")(d.sum[config.currentInfo] * 100));

    d3.selectAll("#info small")
          .on("click", (d, i, nodes) => {
            if (d3.select(nodes[i]).classed("active")) return;

            d3.selectAll(nodes).classed("active", false);
            d3.select(nodes[i]).classed("active", true);
            config.currentInfo = nodes[i].dataset.guide;
            if (config.currentInfo === "得票率") {
              rateForWidth.domain([0, 0.6]);
            } else if (config.currentInfo === "得票数") {
              if (config.selectedCity === "茨城県") {
                rateForWidth.domain([0, 500000]);
              } else {
                rateForWidth.domain([0, 60000]);
              }
            }
            updateInfo();
          });

    function updateInfo() {
      info.select("h4").text(config.selectedCity);

      rows.selectAll("div.inner")
          .transition().duration(250)
          .style("width", v => rateForWidth(v.values[config.selectedCity][config.currentInfo]) + "%");

      rows.selectAll("div.inner")
          .selectAll("span")
          .text(v => config.currentInfo === "得票率" ?  d3.format(".1f")(v.values[config.selectedCity][config.currentInfo] * 100) : d3.format(",")(v.values[config.selectedCity][config.currentInfo]));
    }


    // create legend

    size.legend = {
      width: Math.max(300, (size.width - padding.left - padding.right) / 2),
      padding: {
        top: 2
      },
      bar: {
        height: 12
      }
    };

    const legend = svg.append("g")
                      .attr("transform", "translate(" + ((size.width - size.legend.width) / 2) + "," + (size.height - padding.bottom) + ")");

    legend.selectAll(".blocks")
          .data([-0.2, -0.1, -0.05, 0, 0.05, 0.1, 0.2])
          .enter()
          .append("g")
          .attr("class", "blocks")
            .append("rect")
            .attr("width", (d, i, nodes) => size.legend.width / nodes.length - 1)
            .attr("height", size.legend.bar.height)
            .attr("x", (d, i, nodes) => i * size.legend.width / nodes.length)
            .attr("y", size.legend.padding.top)
            .attr("fill", d => rateColor(d))
            .style("cursor", "pointer")
            .on("click", function(d) {

              const geojson = {type: "FeatureCollection", features: baselayer.selectAll(".rate" + parseInt(d * 100, 10)).data()};
              const topology = topojson.topology({selected: geojson}, 1e6);

              const merg = topojson.mesh(topology, topology.objects.selected, (a, b) => a === b);

              overlay1.selectAll(".selected")
                      .remove();

              overlay1.append("path")
                      .datum(merg)
                      .attr("class", "selected")
                      .attr("d", path)
                      .style("stroke", d === 0 ? "#6900ab" : d > 0 ? d3.rgb(rateColor.range()[2]).darker() : d3.rgb(rateColor.range()[0]).darker());

            });

    legend.selectAll(".blocks")
            .append("text")
            .attr("x", (d, i, nodes) => d < 0 ? (i + 1) * size.legend.width / nodes.length : i * size.legend.width / nodes.length)
            .attr("y", 0)
            .attr("dx", d => d < 0 ? ".5em" : "-.5em")
            .attr("dy", "-.2em")
            .attr("text-anchor", d => d > 0 ? "start" : "end")
            .text(d => d !==0 ? (d * 100) : "");

    legend.append("text")
          .attr("x", 0)
          .attr("y", size.legend.padding.top + size.legend.bar.height)
          .attr("dy", ".5em")
          .attr("text-anchor", "start")
          .attr("dominant-baseline", "text-before-edge")
          .text("橋本氏優勢");

    legend.append("text")
          .attr("x", size.legend.width)
          .attr("y", size.legend.padding.top + size.legend.bar.height)
          .attr("dy", ".5em")
          .attr("text-anchor", "end")
          .attr("dominant-baseline", "text-before-edge")
          .text("大井川氏優勢");

  });

</script>
